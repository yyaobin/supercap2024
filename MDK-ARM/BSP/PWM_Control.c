/*
                                     2022赛季必胜
                                                                    *****        *
              *****                                                ****         ****
				    *********                                             ****         *****
				  ******   *****                                           ******      *****
         *****      *****                                          ****************
         ******     ****                                           ***********
          ******   ****                                            *******
            *********                                             *******
               ******                  *******                   ******
			     **************    ***************************     ******************
			  *************************************************************************
			 ***************************************************************************
			*****************************************************************************
			******************************************************************************
		 ********************************************************************************
		 ********************************************************************************
		***************   ******************************************   *******************
		*************       **************************************       *****************
		***********              一切版权归NewMaker战队所有                ***************
		************        **************************************        ****************
		***************   ******************************************   *******************
		 ********************************************************************************
		 ********************************************************************************
			******************************************************************************
			******************************************************************************
			******************************************************************************
			 ****************************************************************************
			 ****** ************************************************************** ******
			  ***** ************************************************************** *****
						_   __             __  ___      __            ___   ____ ___  ___ 
					 / | / /__ _      __/  |/  /___ _/ /_____  ____|__ \ / __ \__ \|__ \
					/  |/ / _ \ | /| / / /|_/ / __ `/ //_/ _ \/ ___/_/ // / / /_/ /__/ /
				 / /|  /  __/ |/ |/ / /  / / /_/ / ,< /  __/ /  / __// /_/ / __// __/ 
				/_/ |_/\___/|__/|__/_/  /_/\__,_/_/|_|\___/_/  /____/\____/____/____/ 

*/ 



/*
                                MMMMM
                                  MMMMMM
                                    MMMMMMM
                                     MMMMMMMM     .
                                      MMMMMMMMM
                                      HMMMMMMMMMM
                                       MMMMMMMMMMMM  M
                                       MMMMMMMMMMMMM  M
                                        MMMMMMMMMMMMM  M
                                        MMMMMMMMMMMMM:
                                        oMMMMMMMMMMMMMM
              .MMMMMMMMMMMMMMo           MMMMMMMMMMMMMMM M
        MMMMMMMMMMMMMMMMMMMMMMMMMMM      MMMMMMMMMMMMMMMM
          MMMMMMMMMMMMMMMMMMMMMMMMMMMM.  oMMMMMMMMMMMMMMM.M
            MMMMMMMMMMMMMMMMMMMMMMMMMMMM  MMMMMMMMMMMMMMMM
              MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
                oMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
                  MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
                    MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM:                     H
                     MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM                  .         MMM
                      MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM              M       MMMMMM
                       .MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM          M   MMMMMMMMMM
                MM.      MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM       M MMMMMMMMMMMM
                    MM    MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM    .MMMMMMMMMMMMMM
                      MM  MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
                        MM MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
               .MMMMMMMMM MMMMMMMMMMMMMMMMMMMMMMMM.MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
                  HMMMMMMMMMMMMMMMMMMMMM.MMMMMMMMM.MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
                     MMMMMMMMMMMMMMM MMM.oMMMMMMM..MMMMMMMMM:MMMMMMMMMMMMMMMMMMMMMMM
                       MMMMMMMMMMMMMM MM..MMMMMMM...MMMMMMM. MMMMMMMMMMMMMMMMMMMMM
                         MMMMMMMMMMMMMMM ..MMMMMM...MMMMMM ..MMMMMMMMMMMMMMMMMMM
                          MMMMMMM:M.MMM.M.. MMMMM M..MMMMM...MMMMMMMMMMMMMMMMMM  MMM
                            MMMM. .M..MM.M...MMMMMM..MMMMM.. MMMMMMMMMMMMMMMMMMMMMMMMMMMMMM .
                             MMMM..M....M.....:MMM .MMMMMM..MMMMMMM...MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
                              MMM.M.. ...M......MM.MMMMM.......MHM.M  .MMMMMMMMMMMMMMMMMMMMMMMMM
                         MMMMMMMM..MM. . MMM.....MMMMMM.M.....M ..MM..M MMMMMMMMMMMMMMMMMMM
                            .MMMMMHMM. ..MMMM. MMM............o..... . .MMMMMMMMMMMMMMM
                               MMM. M... .........................M..:.MMMMMMMMMMMM
                                 oMMM............ .................M.M.MMMMMMMMM
                                    .....MM........................ . MMMMMM
                                   M.....M.....................o.MM.MMMMMMMM.
                                    M........................M.. ...MMMMMMMMMMMMMo
                                      :....MMM..............MMM..oMMMMMMM
                                       M...MMM.............MMMMMMM
                                          .............:MMMMMMMM
                                          M..... MMM.....M
                                          M M.............
                                          ................M
                                       ooM.................MM  MoMMMMMoooM
                                  MMoooM......................MoooooooH..oMM
                              MHooooMoM.....................MMooooooM........M
                            oooooooMoooM......... o........MoooooooM............
                            Mooooooooooo.......M.........Moooooooo:..............M
                           MooMoooooooooM...M........:Mooooooooooo:..............M
                          M..oooooooooooo .........Mooooooooooooooo..............M
                         M...Mooo:oooooooo.M....ooooooooooooooooooo..M...........M
                          ...oooooMoooooooM..Mooooooooooooo:oooooooM.M...........M.
                         M...ooooooMoo:ooooMoooooooooooooHoooooooooH:M. ...........:
                         M..MoooooooMoooooooooooooooooo:ooooooMooooMoM..............M
                         M..ooooooooooMooooooooooooooHoooooooMooHooooM...............M
                         ...ooooooooooooooooooo:MooooooooooooooMoMoooM................
                        M...oooooooooooooooooooooooooooooooooooooMooMM................M
                        ...MooooooooooooooooooooooooooooooooooooooooMo ................
                        ...MooooooooooooooooooooooooooooooooooooooooM M................M
                       M...ooooooooooooooooooooooooooooooooooooooooM   ................M
                       ...MoooooooooooooooooooooooooooooooooooooooMM   .:...............
                       .....MooooooooooooooooooooooooooooooooooooMoo       .............M
                       M...... ooooooooooooooooooooooooooooooooooooM       M..............M
                       M........MooooMMM MM MM  MMMMMMMMMooooooooM         M...............M
                       .........HM     M:  MM :MMMMMM          M           M...............
                      M..........M     M   MoM M                           M................M
                      M.........:M  MoH  M M M MooooHoooMM.   M             M...............M
                      M..........Moooo MMooM    oooooMooooooooM              M..............H
                      M.........MooooM  Mooo  : ooooooMooooMoooM              M........ . .o.M
                      H..  .....ooooo   oooo  M MooooooooooooooM               M... MMMMMMMMMMM
                      MMMMMMMMMMooooM M oooo  .  ooooooMooooooooM              .MMMMMMMMMMMMMMM
                      MMMMMMMMMMooooH : ooooH    oooooooooooooooo               MMMMMMMMMMMMMMM
                      MMMMMMMMMMoooo    ooooM    Moooooooooooooooo              .MMMMMMMMMMMMMMM
                      MMMMMMMMMMoooo    ooooM    MooooooooooooooooM              MMMMMMMMMMMMMMM
                      MMMMMMMMMMoooM    ooooM     ooooooooooooooooo               MMMMMMMMMMM:M
                      MMMMMMMMMMoooM   MooooM     oooooooooooMoooooo               MH...........
                       . ......Mooo.   MooooM     oooooooooooooooooo              M............M
                      M.M......oooo    MooooM     Moooooooooooooooooo:           .........M.....
                      M.M.....Moooo    MooooM      ooooooooooooooooooM            .M............
                      .......MooooH    MooooM      oooooooooMoooooooooo          M..o...M..o....M
                      .o....HMooooM    MooooH      MooooooooMooooooooooM          .:M...M.......M
                     M..M.....MoooM    :oooo:    .MooooooooHooMoooooooooM         M M... ..oM.M
                      M...M.:.Mooo. MMMMooooo   oooooooooooMoooooooooooooM          ....M. M
                       M:M..o.Moooooooooooooo MooooooooooooooMooooooooooooM          .Mo
                              MooooooooooooooMooooooooooooMoMoooooooooooooo
                              Mooooooooooooooo:ooooooooooooooooooooooooooooo
                              ooooooooooooooooMooooooooooMoooooooooooooooooo
                              ooooooooooooooooMoooooooooooMooooooooooooooooHo
                              ooMooooooooooooooMoooooooooooooooooooooooooooMoM
                             MooMoooooooooooooo.ooooooooooooooooooooooooooo:oM
                             MoooooooooooooooooooooooooooooooooooooooooooooooM
                             MoooMooooooooooooooMooooooooooooooooooooooooooooo.
                             MoooMooooooooooooooMoooooooooooooooooooooooooMooooM
                             MooooooooooooooooooMoooooooooooooooooooooooooMoooooM
                             MooooMoooooooooooooMoooooooooooooooooooooooooMoHooooM
                             ooooooMooooooooooooooooooooooooooooooooooooooooMoMoooM
                            MooooooooooooooooooooMooooooooooooooooooooooooooMoooooH:
                            MoooooooMooooooooooooMoooooooooooooooooooooooooooooHoooM
                            MooooooooMoooooooooooMoooooooooooooooooooooooooMoooMooooM
                            Moooooooooooooooooooooooooooooooooooooooooooooo.oooMooooo
                            MoooooooooooooooooooooooooooooooooooooooooooooMoooooooooM
                             MooooooooooooooooooooMoooooooooooooooooooooooooooooooooM
                              MooooooooooooooooooooMHooooooooooooooooooooMoooo:ooooo
                               MMooooooooooooooooooMoMHoooooooooooooooooooooooMooooo
                                MMoooooooooooooooMMooo MMooooooooooooooooooooooooooM
                                MMMoooooooooooooMooooo  oooooooooooooooooooooMooooo
                                MooMMoooooooooMoooMMoM  ooooHooooooooooooooooMooooM
                                MooooMooooooMooooMoooM  MoooooMoooooooooooooMooooo
                                ooooooMMooooooooMooooM  MoooooooooMooooooooooooooM
                                HooooooMoooooooMooooM    HoooooooHooMooooooooooooo
                                 oooMoooooooooHoooM         MoooooooooMoooooooooM
                                  HooooooooooooHM             MooooooooMMoooooooM
                                   MMMMMMMMMMMMMM                Moooooo:MooooHMM
                                    MMMMMMM: ...                  MMMMMMMMMMMMMM
                                   M............M                  MMMMMMMMM ....
                                   M.MM..........                  M.............M
                                M ..............MM                 M..............
                             MMMMM............MMMM                 ..MMMMMMMM ....M
                           MMMMMMMMMMMMMMMMMMMMMMMM               MMMMMMMMMMMMM...M
                        .MMMMMMMMMMMMMMMMMMMMMMMMMM               MMMMMMMMMMMMMMMMMM
                        MMMMMMMMMMMMMMMMMMMMMMMMM                MMMMMMMMMMMMMMMMMMM
                        :MMMMMMMMMMMMMMMMMMH                     MMMMMMMMMMMMMMMMMMM
                           By EBEN Jér?me                        MMMMMMMMMMMMMMMMMM
                                                                 MMMMMMMMMMMMMMM
                                                                  HMMMMMM                  /超级赛亚人，Bug终结者/

        */
/**
  **************************************************************************************************************************************
  * @file           : PWM_Control.c
  * @brief          : 请看完注释再欣赏
  ********************************************************
  * @param pwm的控制程序
  * @param 主要由三级控制构成，一级是外环闭环底盘功率和缓冲能量，并计算出当前电容充电电流（可为负）
  * @param                     二级是内环闭环电容电流和电压，任意闭环时刻电容的电压不会低于7V高于23.5V，电流不会超过+-15A
  * @param                     三级是PWM波控制，通过双环计算的结果转化成pwm波，自动切换BUCK,BOOST模式，pwm波型对称，占空比介于0.15~0.95
  * @param 内含过流保护，过压保护和过功率保护
  * @param 此代码经实际测试恒流模式电流波动一般不会超过正负0.2安，上电除外
	* @param 本程序由四环pid两并串两并构成，由于并行pid任意时刻只有一个起作用，如果用增量式误差累积容易短时间失调
  * @param 且增量式响应过快对电容板不利，故全部使用位置式，至于增量式的效果未知，但本人所用效果不佳
	* @param 
	* @param 注意事项： 1.Init_Task.c中的Init_Open_Control()中有开启pwm波语句，注释之后电容将不输出;
	* @param            2.PWM_Control.c中hrpwm_tim( )中有BUCK，BOOST的测试语句，如果不注释会以开环形式输出;
	* @param            3.Init_Cap_Low_Voltage_Protection() 中的低压情况下的开环充电给定值需视实际效果做一定调整;
	* @param            4.宏定义于lib.h中更改,更改不同板的ADC及相关限制程度，另外两个宏定义已经放弃维护，不能直接使用了;
	* @param            5.自定义UI有bug，协议不完全对;
	* @param            6.程序带有软件保护，并且可以自动重启，未触发保护led常亮，保护关闭输出led双闪，重启后led灭
	* @param            7.两个主动按键可以切换屏幕显示内容，一页是电流电压，还有一页是连接信息，电容是否连接，can是否正常，电源是否正常
	* @param 
  * @param UpdateV3.0 1.新增定时器4用于费时任务，加快主线程的运行速度，改善原来闭环响应问题
  * @param            2.将外环的pid形式进行改善，进一步加快响应，但是缓冲能量环暂时未实际调试，但是不影响使用
	* @param 
  * @param 待改善：   1.可以试试Freertos多线程，不过和定时器的作用相同，但是可能效果会好点;
  * @param            2.缓启动可以继续优化，比如开电先闭内环，再闭外环，比如开电外环斜坡，比如缓启动闭环电流而不是直接开环等等;
  * @param            3.有必要时可以判断是否信任并使用缓冲能量环，防止上位机缓冲能量出问题影响电容，也能更好的充放电;
  * @param            4.可以尝试用用卡尔曼滤波adc，应该有效但是效果得测试;
	* @param            5.FDCAN可以两个一起用，收到哪个can数据就用哪个can发，增强程序健壮性;
	* @param            6.下供的舵机pwm控制可以直接由主控发送一个pwm值，然后电容板赋予这个值，最大程度的增强电容板的通用性;
	* @param            7.收发数据的id可以设成一样的，方便使用，记忆;
	* @param            8.可以写一个自动校准ADC的程序，不用debug看adc计算公式了;
  ****************************************************************************************************************************************
  */



#include "PWM_Control.h"
#include "lib.h"
#include "hrtim.h"
#include "Init_Task.h"
#include "BSP_CAN_FD.h"
#include "math.h"



/**********************************************************************************
	 * @brief                    You may think you know what the following code does.
	 * @brief                    But you dont. Trust me.
	 * @brief                    Fiddle with it, and youll spend many a sleepless
	 * @brief                    night cursing the moment you thought youd be clever
	 * @brief                    enough to "optimize" the code below.
	 * @brief                    Now close this file and go play with something else.
  *********************************************************************************/
hrpwm_t hrpwm;    //pwm相关结构体
void PWM_Task()
{
		#if Power_Loop ==1
	  //全自动电容充放电控制
				Power_Limit_Loop();//外环，更新功率环，计算目标电流算法
    #else
	  //手动模式下的充放电功率控制
		Model_Switch();
    #endif
		
		hrpwm.I_ramp=hrpwm.I_aim;//由功率PID计算得到的赋值
//		hrpwm.I_ramp=1000;
	  //PID计算电流
	  HRPWM_Control();//内环，更新电流环，赋值pwm算法
	  
	  //hrpwm波形更新
	  hrpwm_tim(); //寄存器赋值
}



/**********************************************************************************
  * @brief                                       自动模式
  * @author                                      Zhu Beibei
  * @param                                       加入限制功率环和缓冲能量环，
  * @param                                       充放电完全自动进行，无需手动开关
  * @retval                                      返回无
  *********************************************************************************/
float power_limit_t;
void Power_Limit_Loop()
{

//增量式
	//关闭电容
	if(can_data.Model==3)
	{
		hrpwm.Power_Out=0;
	}
	
	else if(can_data.Model==4)
		{
			if(can_data.charge_sign1==1)
			hrpwm.Power_Out=can_data.charge_power*1000;//充
			else if(can_data.charge_sign1==2)
			hrpwm.Power_Out=-can_data.charge_power*1000;//放
		}
	else
	{
			 if(hrpwm.Loop_cnt>4||hrpwm.Loop_cnt<-4)//pid积分抗饱和，限制i，在达到最高或最低时，限制i，防止过充或过放
			 {
					 //限制功率环            现在值         目标值，最大50w
					 velocity_control_angle(&Out_Power_Loop,can_data.power_limit,adc.Power_t,Max_Power,35000.0f);
					 //缓冲能量环
					 velocity_control_angle(&Out_Buff_Loop,can_data.power_buff,50,Max_Power,20000.0f);
			 }
			 else
			 {
					 //限制功率环																		ioutmax
					 velocity_control_angle(&Out_Power_Loop,can_data.power_limit,adc.Power_t,Max_Power,260000.0f);
					 //缓冲能量环
					 velocity_control_angle(&Out_Buff_Loop,can_data.power_buff,50,Max_Power,80000.0f);
				   
				   //只充不放模式下的pid积分抗饱和，2，只充不放
				   if(Out_Power_Loop.iout<-20000&&can_data.Model==2)  Out_Power_Loop.iout=-20000;
				   if(Out_Buff_Loop.iout<-20000&&can_data.Model==2)   Out_Buff_Loop.iout=-20000;
			 }
			 
			 //双环并行输出，取小
			 if(Out_Power_Loop.out_angle_total>Out_Buff_Loop.out_angle_total)
					hrpwm.Loop_Out=Out_Buff_Loop.out_angle_total;
			 else
					hrpwm.Loop_Out=Out_Power_Loop.out_angle_total;
			 
			 //充电模式不放电
			if(can_data.Model==2)
		 {
				 if(hrpwm.Loop_Out<0)     hrpwm.Loop_Out=0;//计算功率pid得到的赋为0
		 }
			 
			 hrpwm.Power_Out=hrpwm.Loop_Out;
	}
	
	
//位置式
			 
		//限制功率环	
//	  velocity_control_angle(&Out_Power_Loop,hrpwm.power_limit_ramp,adc.Power_t,10000,10.0f);
//		//缓冲能量环
//		velocity_control_angle(&Out_Buff_Loop,can_data.power_buff,50,10000,10.0f);
////		if(Out_Power_Loop.out_angle_total<-4000) Out_Power_Loop.out_angle_total=-4000;
//	  if(Out_Buff_Loop.out_angle_total<-4000) Out_Buff_Loop.out_angle_total=-4000;
//    
//		//双环并行输出，取小
//		if(Out_Power_Loop.out_angle_total>Out_Buff_Loop.out_angle_total)
//				hrpwm.Loop_Out=Out_Buff_Loop.out_angle_total;
//		else
//				hrpwm.Loop_Out=Out_Power_Loop.out_angle_total;
//	  
		//当电容充满电或放完电后pid结果就不再附给目标值了，加快响应速度
//		if((hrpwm.Loop_Out>0&&hrpwm.Loop_cnt<-5)||(hrpwm.Loop_Out<0&&hrpwm.Loop_cnt>5))
//			hrpwm.Power_Out=hrpwm.Power_Out;
//		else
//		  hrpwm.Power_Out=hrpwm.Loop_Out;
		
		
		//限制最大充放电功率150W
//		if(hrpwm.Power_Out>250000)        hrpwm.Power_Out=250000;
//		else  if(hrpwm.Power_Out<-250000) hrpwm.Power_Out=-250000;

		//计算电流                     W              mv
		hrpwm.I_aim = (float)((hrpwm.Power_Out)* 1000/adc.U_Out_Cap);
	  
}



//舵机控制
//void Magazine_Control()
//{
////	#if Robot ==3//下供小黄
//		if(can_data.magazine_sign==0)
//				 TIM2->CCR1=0;
//			else if(can_data.magazine_sign==1)
//				 TIM2->CCR1=1950;
//			else if(can_data.magazine_sign==2)
//				 TIM2->CCR1=800;
////#endif
////		
////#if Robot ==4
////   if(can_data.magazine_sign==0)
////				 TIM2->CCR1=0;
////			else if(can_data.magazine_sign==1)
////				 TIM2->CCR1=1950;
////			else if(can_data.magazine_sign==2)
////				 TIM2->CCR1=800;
////#endif
////		
////#if Robot ==5//上供
////	
////#endif
//			
//}



/**********************************************************************************
  * @brief                                       hrpwm波型控制
  * @author                                      Z
  * @param                                       定时器进入，1ms一次
  * @retval                                      返回无
  *********************************************************************************/
void HRPWM_Control()
{
	   
		 //电容容量计算                                     mv,需要除以1000
		 hrpwm.Super_Cap_Power=(adc.U_Out_Cap*adc.U_Out_Cap*1.0f/1000000-49)/6.27f;
		 if(hrpwm.Super_Cap_Power<0) hrpwm.Super_Cap_Power=0;
		 else if(hrpwm.Super_Cap_Power>100) hrpwm.Super_Cap_Power=100;
	   
	   //限制最大充放电电流Max_I(mA)
	   if(hrpwm.I_ramp>Max_I)              hrpwm.I_ramp=Max_I;
	   else 	   if(hrpwm.I_ramp<-Max_I)   hrpwm.I_ramp=-Max_I;//经过第一次PID计算出MAXI
	   
#if Speed_Loop ==0 //位置式
		 if(hrpwm.I_ramp>=0)//充电，电压环与电流环并行输出，电压环防止超电压和低电压
		 {                                           //目标值       获取
					velocity_control_angle(&Out_I_Loop,hrpwm.I_ramp,adc.I_Out_Cap,300,50.0f);
					velocity_control_angle(&Out_U_Loop,25000,adc.U_Out_Cap,300,10.0f);
					if(Out_I_Loop.out_angle_total<=Out_U_Loop.out_angle_total)
					{
						

							 hrpwm.CompareValue=Out_I_Loop.out_angle_total;
						   hrpwm.Loop_cnt=0;
					}//取小
					else
					{    //如果电压环生效产生标志位防止外环累计
							 hrpwm.CompareValue=Out_U_Loop.out_angle_total;
						   hrpwm.Loop_cnt--;//双重限制
					}
		 }//ADC采集到的都是ma,mv级别的，在外环的功率环和缓冲环中，都将ADC采集到的值除1000，而在内环的电流环电压环中，就按1000精度
		 //来计算，精度高一些，在打印曲线上，为何功率环iout要乘10，而ADC采集power已经除1000000基础上为何乘100
		 else//放电
		 {
			velocity_control_angle(&Out_I_Loop,hrpwm.I_ramp,adc.I_Out_Cap,300,50.0f);
			velocity_control_angle(&Out_U_Loop,7000,adc.U_Out_Cap,300,10.0f);
					if(Out_I_Loop.out_angle_total>=Out_U_Loop.out_angle_total)
					{
							 hrpwm.CompareValue=Out_I_Loop.out_angle_total;
						   hrpwm.Loop_cnt=0;
					}//取大
					else
					{
							 hrpwm.CompareValue=Out_U_Loop.out_angle_total;		
						   hrpwm.Loop_cnt++;//iout
					}
		 }
		 
		 if(hrpwm.Loop_cnt>20)  hrpwm.Loop_cnt=20;
		 else  if(hrpwm.Loop_cnt<-20)  hrpwm.Loop_cnt=-20;
		 
		 //pid附上
		 hrpwm.I_Out+=hrpwm.CompareValue;
		 
		 //限幅
		 if(hrpwm.I_Out>3840)    hrpwm.I_Out=3840;
		 else if(hrpwm.I_Out<0)	 hrpwm.I_Out=0;
		 
		 //模式切换
		 if(hrpwm.I_Out<1920)//buck模式，充电
		 {
					hrpwm.TA1=hrpwm.I_Out+2400*0.15f;//防止降压幅度太大，电流太大，导致烧坏，最大占空比0.95
					hrpwm.TB1=2400*0.95f;//如果算上死区，0.95基本占满占空比
		 }
		 else if(hrpwm.I_Out>=1920)//boost模式，放电
		 {
					hrpwm.TA1=2400*0.95f;//                                                         3840      1920
					hrpwm.TB1=4200-hrpwm.I_Out;//无形中把占空比拉下了一部分，计算可得D最大为0.85,D在0.15到0.95之间
		 }
		 
#else  //增量式
     if(hrpwm.I_ramp>=0)//充电，电压环与电流环并行输出，电压环防止超电压和低电压
		 {
					velocity_control_speed(&Out_I_Loop,hrpwm.I_ramp,adc.I_Out_Cap,1920,200);
					velocity_control_speed(&Out_U_Loop,23500,adc.U_Out_Cap,1920,200);
					if(Out_I_Loop.out_speed_total<=Out_U_Loop.out_speed_total)
							 hrpwm.CompareValue=Out_I_Loop.out_speed_total;
					else
							 hrpwm.CompareValue=Out_U_Loop.out_speed_total;
		 }
		 else//放电
		 {
					velocity_control_speed(&Out_I_Loop,hrpwm.I_ramp,adc.I_Out_Cap,1920,200);
          velocity_control_speed(&Out_U_Loop,7000,adc.U_Out_Cap,1920,200);
					if(Out_I_Loop.out_speed_total>=Out_U_Loop.out_speed_total)
							 hrpwm.CompareValue=Out_I_Loop.out_speed_total;
					else
							 hrpwm.CompareValue=Out_U_Loop.out_speed_total;		
		 }
		 
		 //pid附上
		 hrpwm.I_Out=hrpwm.CompareValue;
		 
		 //模式切换
		 if(hrpwm.I_Out<0)//buck模式
		 {
					hrpwm.TA1=hrpwm.I_Out+2400*0.15f+1920;
					hrpwm.TB1=2400*0.95f;
		 }
		 else if(hrpwm.I_Out>=0)//boost模式
		 {
					hrpwm.TA1=2400*0.95f;
					hrpwm.TB1=4200-hrpwm.I_Out-1920;
		 }
		 
#endif
}



/**********************************************************************************
  * @brief                                       pwm更新
  * @author                                      Z
  * @param                                       1ms进入一次
  * @retval                                      返回无
  *********************************************************************************/
void hrpwm_tim( )
{

		//赋值给pwm
//		HRTIM1->sMasterRegs.MCMP1R = (int)hrpwm.TA1 ;
//		HRTIM1->sMasterRegs.MCMP2R = (int)hrpwm.TB1 ;//上车用这个
		
//	  //调试用，切勿忘记注释
		HRTIM1->sMasterRegs.MCMP1R =1600;//buck                          
		HRTIM1->sMasterRegs.MCMP2R =0;//调试时2个不要同时给，   0.95（2240）    比较寄存器，CCR      	 ARR 2400
//	
	
//		HRTIM1->sMasterRegs.MCMP1R = 0;//BOOST
//		HRTIM1->sMasterRegs.MCMP2R = 2000 ;
	

	
	  
}



/**********************************************************************************
  * @brief                                       手动充放电控制
  * @author                                      Z
  * @param                                       定时器进入，1ms一次
  * @retval                                      返回无
  *********************************************************************************/
void Model_Switch()
{
                
	      //充放电功率选择
        if(can_data.super_cap_sign==2)
				{
					if(can_data.Violent_Model==1)//狂暴模式下放电100w
					{
						if(can_data.power_limit<=55)
					    hrpwm.Power_Aim=-120;
						else if(can_data.power_limit==60)
							hrpwm.Power_Aim=-100;
						else if(can_data.power_limit==80)
							hrpwm.Power_Aim=-100;
						else if(can_data.power_limit>=100)
							hrpwm.Power_Aim=-100;
					}
					else
					  hrpwm.Power_Aim=-40;
				
				}
				else if(can_data.super_cap_sign==1||can_data.super_cap_sign==0)
				{
					if(can_data.Violent_Model==1)//狂暴模式不充电
						hrpwm.Power_Aim=0;
					else
					{
						if(can_data.power_limit<60&&can_data.power_limit>0)
					    hrpwm.Power_Aim=10;
						else if(can_data.power_limit==60)
							hrpwm.Power_Aim=20;
						else if(can_data.power_limit==80)
							hrpwm.Power_Aim=30;
						else if(can_data.power_limit>=100)
							hrpwm.Power_Aim=40;
						else 
							hrpwm.Power_Aim=50;//主控离线的充电功率 
				  }
				}
				
				//充放电逻辑控制
				if(hrpwm.Super_Cap_Power>=99&&can_data.super_cap_sign==1)
				{
					hrpwm.Charge_sign=3;
				}
				else if(hrpwm.Super_Cap_Power==0&&can_data.super_cap_sign==2)
				{
					hrpwm.Charge_sign=0;
				}
				else
				{
					if(can_data.super_cap_sign==1)//开电开始充电和放完电自动开始充电
							hrpwm.Charge_sign=1;//充电
					else if(can_data.super_cap_sign==2)
							hrpwm.Charge_sign=2;//放电
			  }
				
				//当缓冲能量消耗时电容放电补充功率，否则放电功率较低
				if(hrpwm.Power_Aim<0&&can_data.Violent_Model==0)//爆发模式直接放电拉满
				{
						if(can_data.power_buff<60&&can_data.power_buff>25)//正常放电
								hrpwm.P_k=1.0f;
						else if(can_data.power_buff>=59)//缓慢放电
							hrpwm.P_k=0.4f;
						else if(can_data.power_buff<=25&&can_data.power_buff>0)//爆发放电
						  hrpwm.P_k=1.2f;
						else//正常放电
							hrpwm.P_k=1.0f;
			  }
				else if(hrpwm.Power_Aim>0&&can_data.Violent_Model==0)
				{
					if(can_data.power_buff>=60)//快速充电
								hrpwm.P_k=1.8f;
					else//正常充电
				  		hrpwm.P_k=1.0f;
				}
				else
				  		hrpwm.P_k=1.0f;
				
				//电流计算                             					mv
				hrpwm.I_aim = hrpwm.Power_Aim * hrpwm.P_k * 1000000/adc.U_Out_Cap;
				
}



